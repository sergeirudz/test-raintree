"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createAppSyncAPI = void 0;
const aws_appsync_1 = require("aws-cdk-lib/aws-appsync");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const path = require("path");
const schemaPath = path.join(__dirname, '../../../../packages/graphql/schema.graphql');
const resolverPath = path.join(__dirname, '../../../../packages/appsync-resolvers/build');
const createAppSyncAPI = (scope, props) => {
    const api = new aws_appsync_1.GraphqlApi(scope, props.apiName, {
        name: props.apiName,
        definition: aws_appsync_1.Definition.fromFile(schemaPath),
        authorizationConfig: {
            defaultAuthorization: {
                authorizationType: aws_appsync_1.AuthorizationType.API_KEY,
            },
        },
        logConfig: {
            fieldLogLevel: aws_appsync_1.FieldLogLevel.ALL,
        },
        xrayEnabled: true,
    });
    const appDataSource = api.addDynamoDbDataSource('AppDataDS', props.dataTable);
    const validateWeightLambda = new aws_lambda_1.Function(scope, 'ValidateWeightFunction', {
        runtime: aws_lambda_1.Runtime.NODEJS_18_X,
        handler: 'validateWeight.handler',
        code: aws_lambda_1.Code.fromAsset(path.join(__dirname, '../functions')),
        timeout: aws_cdk_lib_1.Duration.seconds(30),
        memorySize: 256,
    });
    const lambdaDataSource = api.addLambdaDataSource('ValidateWeightDataSource', validateWeightLambda);
    const validateWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'ValidateWeightAppsyncFunction', {
        name: 'validateWeightFunction',
        api,
        dataSource: lambdaDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/validateWeight.js')),
    });
    const createWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'CreateWeightAppsyncFunction', {
        name: 'createWeightFunction',
        api,
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/createWeight.js')),
    });
    const updateWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'UpdateWeightAppsyncFunction', {
        name: 'updateWeightFunction',
        api,
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/updateWeight.js')),
    });
    api.createResolver('getUserResolver', {
        typeName: 'Query',
        fieldName: 'getUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/getUser.js')),
    });
    api.createResolver('listUsersResolver', {
        typeName: 'Query',
        fieldName: 'listUsers',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/listUsers.js')),
    });
    api.createResolver('listWeightsByUserResolver', {
        typeName: 'Query',
        fieldName: 'listWeightsByUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/listWeightsByUser.js')),
    });
    api.createResolver('createUserResolver', {
        typeName: 'Mutation',
        fieldName: 'createUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/createUser.js')),
    });
    api.createResolver('updateUserResolver', {
        typeName: 'Mutation',
        fieldName: 'updateUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/updateUser.js')),
    });
    api.createResolver('deleteUserResolver', {
        typeName: 'Mutation',
        fieldName: 'deleteUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/deleteUser.js')),
    });
    api.createResolver('createWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'createWeight',
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        pipelineConfig: [validateWeightFunction, createWeightFunction],
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/createWeightPipeline.js')),
    });
    api.createResolver('updateWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'updateWeight',
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        pipelineConfig: [validateWeightFunction, updateWeightFunction],
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/updateWeightPipeline.js')),
    });
    api.createResolver('deleteWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'deleteWeight',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/deleteWeight.js')),
    });
    api.createResolver('userWeightsFieldResolver', {
        typeName: 'User',
        fieldName: 'weights',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'fieldResolvers/User.weights.js')),
    });
    return api;
};
exports.createAppSyncAPI = createAppSyncAPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcHN5bmMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseURBUWlDO0FBRWpDLHVEQUErRTtBQUMvRSw2Q0FBdUM7QUFFdkMsNkJBQTZCO0FBTzdCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQzFCLFNBQVMsRUFDVCw2Q0FBNkMsQ0FDOUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQzVCLFNBQVMsRUFDVCw4Q0FBOEMsQ0FDL0MsQ0FBQztBQUVLLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFnQixFQUFFLEtBQXNCLEVBQUUsRUFBRTtJQUMzRSxNQUFNLEdBQUcsR0FBRyxJQUFJLHdCQUFVLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUU7UUFDL0MsSUFBSSxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ25CLFVBQVUsRUFBRSx3QkFBVSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDM0MsbUJBQW1CLEVBQUU7WUFDbkIsb0JBQW9CLEVBQUU7Z0JBQ3BCLGlCQUFpQixFQUFFLCtCQUFpQixDQUFDLE9BQU87YUFDN0M7U0FDRjtRQUNELFNBQVMsRUFBRTtZQUNULGFBQWEsRUFBRSwyQkFBYSxDQUFDLEdBQUc7U0FDakM7UUFDRCxXQUFXLEVBQUUsSUFBSTtLQUNsQixDQUFDLENBQUM7SUFFSCxNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUMscUJBQXFCLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUU5RSxNQUFNLG9CQUFvQixHQUFHLElBQUkscUJBQVEsQ0FBQyxLQUFLLEVBQUUsd0JBQXdCLEVBQUU7UUFDekUsT0FBTyxFQUFFLG9CQUFPLENBQUMsV0FBVztRQUM1QixPQUFPLEVBQUUsd0JBQXdCO1FBQ2pDLElBQUksRUFBRSxpQkFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMs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QUFRO1FBQ2pDLGNBQWMsRUFBRSxDQUFDLHNCQUFzQixFQUFFLG9CQUFvQixDQUFDO1FBQzlELElBQUksRUFBRSxrQkFBSSxDQUFDLFNBQVMsQ0FDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsa0NBQWtDLENBQUMsQ0FDNUQ7S0FDRixDQUFDLENBQUM7SUFFSCxHQUFHLENBQUMsY0FBYyxDQUFDLHNCQUFzQixFQUFFO1FBQ3pDLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLFNBQVMsRUFBRSxjQUFjO1FBQ3pCLFVBQVUsRUFBRSxhQUFhO1FBQ3pCLE9BQU8sRUFBRSw2QkFBZSxDQUFDLFFBQVE7UUFDakMsSUFBSSxFQUFFLGtCQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLDJCQUEyQixDQUFDLENBQUM7S0FDM0UsQ0FBQyxDQUFDO0lBRUgsR0FBRyxDQUFDLGNBQWMsQ0FBQywwQkFBMEIsRUFBRTtRQUM3QyxRQUFRLEVBQUUsTUFBTTtRQUNoQixTQUFTLEVBQUUsU0FBUztRQUNwQixVQUFVLEVBQUUsYUFBYTtRQUN6QixPQUFPLEVBQUUsNkJBQWUsQ0FBQyxRQUFRO1FBQ2pDLElBQUksRUFBRSxrQkFBSSxDQUFDLFNBQVMsQ0FDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsZ0NBQWdDLENBQUMsQ0FDMUQ7S0FDRixDQUFDLENBQUM7SUFFSCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMsQ0FBQztBQWpLVyxRQUFBLGdCQUFnQixvQkFpSzNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQXV0aG9yaXphdGlvblR5cGUsXG4gIERlZmluaXRpb24sXG4gIEZpZWxkTG9nTGV2ZWwsXG4gIEdyYXBocWxBcGksXG4gIEZ1bmN0aW9uUnVudGltZSxcbiAgQ29kZSxcbiAgQXBwc3luY0Z1bmN0aW9uLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBwc3luYyc7XG5pbXBvcnQgeyBUYWJsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgeyBGdW5jdGlvbiwgUnVudGltZSwgQ29kZSBhcyBMYW1iZGFDb2RlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxudHlwZSBBcHBTeW5jQVBJUHJvcHMgPSB7XG4gIGFwaU5hbWU6IHN0cmluZztcbiAgZGF0YVRhYmxlOiBUYWJsZTsgLy8gU2luZ2xlIHRhYmxlIGZvciBib3RoIGVudGl0aWVzXG59O1xuXG5jb25zdCBzY2hlbWFQYXRoID0gcGF0aC5qb2luKFxuICBfX2Rpcm5hbWUsXG4gICcuLi8uLi8uLi8uLi9wYWNrYWdlcy9ncmFwaHFsL3NjaGVtYS5ncmFwaHFsJ1xuKTtcblxuY29uc3QgcmVzb2x2ZXJQYXRoID0gcGF0aC5qb2luKFxuICBfX2Rpcm5hbWUsXG4gICcuLi8uLi8uLi8uLi9wYWNrYWdlcy9hcHBzeW5jLXJlc29sdmVycy9idWlsZCdcbik7XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVBcHBTeW5jQVBJID0gKHNjb3BlOiBDb25zdHJ1Y3QsIHByb3BzOiBBcHBTeW5jQVBJUHJvcHMpID0+IHtcbiAgY29uc3QgYXBpID0gbmV3IEdyYXBocWxBcGkoc2NvcGUsIHByb3BzLmFwaU5hbWUsIHtcbiAgICBuYW1lOiBwcm9wcy5hcGlOYW1lLFxuICAgIGRlZmluaXRpb246IERlZmluaXRpb24uZnJvbUZpbGUoc2NoZW1hUGF0aCksXG4gICAgYXV0aG9yaXphdGlvbkNvbmZpZzoge1xuICAgICAgZGVmYXVsdEF1dGhvcml6YXRpb246IHtcbiAgICAgICAgYXV0aG9yaXphdGlvblR5cGU6IEF1dGhvcml6YXRpb25UeXBlLkFQSV9LRVksXG4gICAgICB9LFxuICAgIH0sXG4gICAgbG9nQ29uZmlnOiB7XG4gICAgICBmaWVsZExvZ0xldmVsOiBGaWVsZExvZ0xldmVsLkFMTCxcbiAgICB9LFxuICAgIHhyYXlFbmFibGVkOiB0cnVlLFxuICB9KTtcblxuICBjb25zdCBhcHBEYXRhU291cmNlID0gYXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnQXBwRGF0YURTJywgcHJvcHMuZGF0YVRhYmxlKTtcblxuICBjb25zdCB2YWxpZGF0ZVdlaWdodExhbWJkYSA9IG5ldyBGdW5jdGlvbihzY29wZSwgJ1ZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24nLCB7XG4gICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICBoYW5kbGVyOiAndmFsaWRhdGVXZWlnaHQuaGFuZGxlcicsXG4gICAgY29kZTogTGFtYmRhQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Z1bmN0aW9ucycpKSxcbiAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICBtZW1vcnlTaXplOiAyNTYsXG4gIH0pO1xuXG4gIGNvbnN0IGxhbWJkYURhdGFTb3VyY2UgPSBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShcbiAgICAnVmFsaWRhdGVXZWlnaHREYXRhU291cmNlJyxcbiAgICB2YWxpZGF0ZVdlaWdodExhbWJkYVxuICApO1xuXG4gIGNvbnN0IHZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24gPSBuZXcgQXBwc3luY0Z1bmN0aW9uKFxuICAgIHNjb3BlLFxuICAgICdWYWxpZGF0ZVdlaWdodEFwcHN5bmNGdW5jdGlvbicsXG4gICAge1xuICAgICAgbmFtZTogJ3ZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24nLFxuICAgICAgYXBpLFxuICAgICAgZGF0YVNvdXJjZTogbGFtYmRhRGF0YVNvdXJjZSxcbiAgICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvdmFsaWRhdGVXZWlnaHQuanMnKVxuICAgICAgKSxcbiAgICB9XG4gICk7XG5cbiAgY29uc3QgY3JlYXRlV2VpZ2h0RnVuY3Rpb24gPSBuZXcgQXBwc3luY0Z1bmN0aW9uKFxuICAgIHNjb3BlLFxuICAgICdDcmVhdGVXZWlnaHRBcHBzeW5jRnVuY3Rpb24nLFxuICAgIHtcbiAgICAgIG5hbWU6ICdjcmVhdGVXZWlnaHRGdW5jdGlvbicsXG4gICAgICBhcGksXG4gICAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihyZXNvbHZlclBhdGgsICdtdXRhdGlvbnMvY3JlYXRlV2VpZ2h0LmpzJylcbiAgICAgICksXG4gICAgfVxuICApO1xuXG4gIGNvbnN0IHVwZGF0ZVdlaWdodEZ1bmN0aW9uID0gbmV3IEFwcHN5bmNGdW5jdGlvbihcbiAgICBzY29wZSxcbiAgICAnVXBkYXRlV2VpZ2h0QXBwc3luY0Z1bmN0aW9uJyxcbiAgICB7XG4gICAgICBuYW1lOiAndXBkYXRlV2VpZ2h0RnVuY3Rpb24nLFxuICAgICAgYXBpLFxuICAgICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL3VwZGF0ZVdlaWdodC5qcycpXG4gICAgICApLFxuICAgIH1cbiAgKTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2dldFVzZXJSZXNvbHZlcicsIHtcbiAgICB0eXBlTmFtZTogJ1F1ZXJ5JyxcbiAgICBmaWVsZE5hbWU6ICdnZXRVc2VyJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncXVlcmllcy9nZXRVc2VyLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2xpc3RVc2Vyc1Jlc29sdmVyJywge1xuICAgIHR5cGVOYW1lOiAnUXVlcnknLFxuICAgIGZpZWxkTmFtZTogJ2xpc3RVc2VycycsXG4gICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ3F1ZXJpZXMvbGlzdFVzZXJzLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2xpc3RXZWlnaHRzQnlVc2VyUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgZmllbGROYW1lOiAnbGlzdFdlaWdodHNCeVVzZXInLFxuICAgIGRhdGFTb3VyY2U6IGFwcERhdGFTb3VyY2UsXG4gICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgcGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ3F1ZXJpZXMvbGlzdFdlaWdodHNCeVVzZXIuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignY3JlYXRlVXNlclJlc29sdmVyJywge1xuICAgIHR5cGVOYW1lOiAnTXV0YXRpb24nLFxuICAgIGZpZWxkTmFtZTogJ2NyZWF0ZVVzZXInLFxuICAgIGRhdGFTb3VyY2U6IGFwcERhdGFTb3VyY2UsXG4gICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KHBhdGguam9pbihyZXNvbHZlclBhdGgsICdtdXRhdGlvbnMvY3JlYXRlVXNlci5qcycpKSxcbiAgfSk7XG5cbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCd1cGRhdGVVc2VyUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAndXBkYXRlVXNlcicsXG4gICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ211dGF0aW9ucy91cGRhdGVVc2VyLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2RlbGV0ZVVzZXJSZXNvbHZlcicsIHtcbiAgICB0eXBlTmFtZTogJ011dGF0aW9uJyxcbiAgICBmaWVsZE5hbWU6ICdkZWxldGVVc2VyJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL2RlbGV0ZVVzZXIuanMnKSksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignY3JlYXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAnY3JlYXRlV2VpZ2h0JyxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgcGlwZWxpbmVDb25maWc6IFt2YWxpZGF0ZVdlaWdodEZ1bmN0aW9uLCBjcmVhdGVXZWlnaHRGdW5jdGlvbl0sXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvY3JlYXRlV2VpZ2h0UGlwZWxpbmUuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcigndXBkYXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAndXBkYXRlV2VpZ2h0JyxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgcGlwZWxpbmVDb25maWc6IFt2YWxpZGF0ZVdlaWdodEZ1bmN0aW9uLCB1cGRhdGVXZWlnaHRGdW5jdGlvbl0sXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvdXBkYXRlV2VpZ2h0UGlwZWxpbmUuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignZGVsZXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAnZGVsZXRlV2VpZ2h0JyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL2RlbGV0ZVdlaWdodC5qcycpKSxcbiAgfSk7XG5cbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCd1c2VyV2VpZ2h0c0ZpZWxkUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdVc2VyJyxcbiAgICBmaWVsZE5hbWU6ICd3ZWlnaHRzJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChcbiAgICAgIHBhdGguam9pbihyZXNvbHZlclBhdGgsICdmaWVsZFJlc29sdmVycy9Vc2VyLndlaWdodHMuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIHJldHVybiBhcGk7XG59O1xuIl19