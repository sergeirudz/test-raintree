"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createAppSyncAPI = void 0;
const aws_appsync_1 = require("aws-cdk-lib/aws-appsync");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const path = require("path");
const schemaPath = path.join(__dirname, '../../../../packages/graphql/schema.graphql');
const resolverPath = path.join(__dirname, '../../../../packages/appsync-resolvers/build');
const createAppSyncAPI = (scope, props) => {
    // Configure authorization - support both API Key and IAM (for Cognito)
    const authorizationConfig = {
        defaultAuthorization: {
            authorizationType: aws_appsync_1.AuthorizationType.API_KEY,
        },
        additionalAuthorizationModes: props.cognitoAuth
            ? [
                {
                    authorizationType: aws_appsync_1.AuthorizationType.IAM,
                },
            ]
            : undefined,
    };
    const api = new aws_appsync_1.GraphqlApi(scope, props.apiName, {
        name: props.apiName,
        definition: aws_appsync_1.Definition.fromFile(schemaPath),
        authorizationConfig,
        logConfig: {
            fieldLogLevel: aws_appsync_1.FieldLogLevel.ALL,
        },
        xrayEnabled: true,
    });
    // Grant Cognito users access to the AppSync API if provided
    if (props.cognitoAuth) {
        props.cognitoAuth.grantAppSyncAccess(api.arn);
    }
    const appDataSource = api.addDynamoDbDataSource('AppDataDS', props.dataTable);
    const validateWeightLambda = new aws_lambda_1.Function(scope, 'ValidateWeightFunction', {
        runtime: aws_lambda_1.Runtime.NODEJS_18_X,
        handler: 'validateWeight.handler',
        code: aws_lambda_1.Code.fromAsset(path.join(__dirname, '../functions')),
        timeout: aws_cdk_lib_1.Duration.seconds(30),
        memorySize: 256,
    });
    const lambdaDataSource = api.addLambdaDataSource('ValidateWeightDataSource', validateWeightLambda);
    const validateWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'ValidateWeightAppsyncFunction', {
        name: 'validateWeightFunction',
        api,
        dataSource: lambdaDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/validateWeight.js')),
    });
    const createWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'CreateWeightAppsyncFunction', {
        name: 'createWeightFunction',
        api,
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/createWeight.js')),
    });
    const updateWeightFunction = new aws_appsync_1.AppsyncFunction(scope, 'UpdateWeightAppsyncFunction', {
        name: 'updateWeightFunction',
        api,
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/updateWeight.js')),
    });
    api.createResolver('getUserResolver', {
        typeName: 'Query',
        fieldName: 'getUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/getUser.js')),
    });
    api.createResolver('listUsersResolver', {
        typeName: 'Query',
        fieldName: 'listUsers',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/listUsers.js')),
    });
    api.createResolver('listWeightsByUserResolver', {
        typeName: 'Query',
        fieldName: 'listWeightsByUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'queries/listWeightsByUser.js')),
    });
    api.createResolver('createUserResolver', {
        typeName: 'Mutation',
        fieldName: 'createUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/createUser.js')),
    });
    api.createResolver('updateUserResolver', {
        typeName: 'Mutation',
        fieldName: 'updateUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/updateUser.js')),
    });
    api.createResolver('deleteUserResolver', {
        typeName: 'Mutation',
        fieldName: 'deleteUser',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/deleteUser.js')),
    });
    api.createResolver('createWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'createWeight',
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        pipelineConfig: [validateWeightFunction, createWeightFunction],
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/createWeightPipeline.js')),
    });
    api.createResolver('updateWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'updateWeight',
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        pipelineConfig: [validateWeightFunction, updateWeightFunction],
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'pipeline/updateWeightPipeline.js')),
    });
    api.createResolver('deleteWeightResolver', {
        typeName: 'Mutation',
        fieldName: 'deleteWeight',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'mutations/deleteWeight.js')),
    });
    api.createResolver('userWeightsFieldResolver', {
        typeName: 'User',
        fieldName: 'weights',
        dataSource: appDataSource,
        runtime: aws_appsync_1.FunctionRuntime.JS_1_0_0,
        code: aws_appsync_1.Code.fromAsset(path.join(resolverPath, 'fieldResolvers/User.weights.js')),
    });
    return api;
};
exports.createAppSyncAPI = createAppSyncAPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcHN5bmMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseURBUWlDO0FBRWpDLHVEQUErRTtBQUMvRSw2Q0FBdUM7QUFHdkMsNkJBQTZCO0FBUTdCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQzFCLFNBQVMsRUFDVCw2Q0FBNkMsQ0FDOUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQzVCLFNBQVMsRUFDVCw4Q0FBOEMsQ0FDL0MsQ0FBQztBQUVLLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFnQixFQUFFLEtBQXNCLEVBQUUsRUFBRTtJQUMzRSx1RUFBdUU7SUFDdkUsTUFBTSxtQkFBbUIsR0FBRztRQUMxQixvQkFBb0IsRUFBRTtZQUNwQixpQkFBaUIsRUFBRSwrQkFBaUIsQ0FBQyxPQUFPO1NBQzdDO1FBQ0QsNEJBQTRCLEVBQUUsS0FBSyxDQUFDLFdBQVc7WUFDN0MsQ0FBQyxDQUFDO2dCQUNFO29CQUNFLGlCQUFpQixFQUFFLCtCQUFpQixDQUFDLEdBQUc7aUJBQ3pDO2FBQ0Y7WUFDSCxDQUFDLENBQUMsU0FBUztLQUNkLENBQUM7SUFFRixNQUFNLEdBQUcsR0FBRyxJQUFJLHdCQUFVLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUU7UUFDL0MsSUFBSSxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ25CLFVBQVUsRUFBRSx3QkFBVSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDM0MsbUJBQW1CO1FBQ25CLFNBQVMsRUFBRTtZQUNULGFBQWEsRUFBRSwyQkFBYSxDQUFDLEdBQUc7U0FDakM7UUFDRCxXQUFXLEVBQUUsSUFBSTtLQUNsQixDQUFDLENBQUM7SUFFSCw0REFBNEQ7SUFDNUQsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdEIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FB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QU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBaExXLFFBQUEsZ0JBQWdCLG9CQWdMM0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBdXRob3JpemF0aW9uVHlwZSxcbiAgRGVmaW5pdGlvbixcbiAgRmllbGRMb2dMZXZlbCxcbiAgR3JhcGhxbEFwaSxcbiAgRnVuY3Rpb25SdW50aW1lLFxuICBDb2RlLFxuICBBcHBzeW5jRnVuY3Rpb24sXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IFRhYmxlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCB7IEZ1bmN0aW9uLCBSdW50aW1lLCBDb2RlIGFzIExhbWJkYUNvZGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBDb2duaXRvQXV0aCB9IGZyb20gJy4uL2F1dGgnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxudHlwZSBBcHBTeW5jQVBJUHJvcHMgPSB7XG4gIGFwaU5hbWU6IHN0cmluZztcbiAgZGF0YVRhYmxlOiBUYWJsZTsgLy8gU2luZ2xlIHRhYmxlIGZvciBib3RoIGVudGl0aWVzXG4gIGNvZ25pdG9BdXRoPzogQ29nbml0b0F1dGg7IC8vIE9wdGlvbmFsIENvZ25pdG8gYXV0aCBpbnRlZ3JhdGlvblxufTtcblxuY29uc3Qgc2NoZW1hUGF0aCA9IHBhdGguam9pbihcbiAgX19kaXJuYW1lLFxuICAnLi4vLi4vLi4vLi4vcGFja2FnZXMvZ3JhcGhxbC9zY2hlbWEuZ3JhcGhxbCdcbik7XG5cbmNvbnN0IHJlc29sdmVyUGF0aCA9IHBhdGguam9pbihcbiAgX19kaXJuYW1lLFxuICAnLi4vLi4vLi4vLi4vcGFja2FnZXMvYXBwc3luYy1yZXNvbHZlcnMvYnVpbGQnXG4pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlQXBwU3luY0FQSSA9IChzY29wZTogQ29uc3RydWN0LCBwcm9wczogQXBwU3luY0FQSVByb3BzKSA9PiB7XG4gIC8vIENvbmZpZ3VyZSBhdXRob3JpemF0aW9uIC0gc3VwcG9ydCBib3RoIEFQSSBLZXkgYW5kIElBTSAoZm9yIENvZ25pdG8pXG4gIGNvbnN0IGF1dGhvcml6YXRpb25Db25maWcgPSB7XG4gICAgZGVmYXVsdEF1dGhvcml6YXRpb246IHtcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBBdXRob3JpemF0aW9uVHlwZS5BUElfS0VZLFxuICAgIH0sXG4gICAgYWRkaXRpb25hbEF1dGhvcml6YXRpb25Nb2RlczogcHJvcHMuY29nbml0b0F1dGhcbiAgICAgID8gW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBBdXRob3JpemF0aW9uVHlwZS5JQU0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXVxuICAgICAgOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgY29uc3QgYXBpID0gbmV3IEdyYXBocWxBcGkoc2NvcGUsIHByb3BzLmFwaU5hbWUsIHtcbiAgICBuYW1lOiBwcm9wcy5hcGlOYW1lLFxuICAgIGRlZmluaXRpb246IERlZmluaXRpb24uZnJvbUZpbGUoc2NoZW1hUGF0aCksXG4gICAgYXV0aG9yaXphdGlvbkNvbmZpZyxcbiAgICBsb2dDb25maWc6IHtcbiAgICAgIGZpZWxkTG9nTGV2ZWw6IEZpZWxkTG9nTGV2ZWwuQUxMLFxuICAgIH0sXG4gICAgeHJheUVuYWJsZWQ6IHRydWUsXG4gIH0pO1xuXG4gIC8vIEdyYW50IENvZ25pdG8gdXNlcnMgYWNjZXNzIHRvIHRoZSBBcHBTeW5jIEFQSSBpZiBwcm92aWRlZFxuICBpZiAocHJvcHMuY29nbml0b0F1dGgpIHtcbiAgICBwcm9wcy5jb2duaXRvQXV0aC5ncmFudEFwcFN5bmNBY2Nlc3MoYXBpLmFybik7XG4gIH1cblxuICBjb25zdCBhcHBEYXRhU291cmNlID0gYXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnQXBwRGF0YURTJywgcHJvcHMuZGF0YVRhYmxlKTtcblxuICBjb25zdCB2YWxpZGF0ZVdlaWdodExhbWJkYSA9IG5ldyBGdW5jdGlvbihzY29wZSwgJ1ZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24nLCB7XG4gICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICBoYW5kbGVyOiAndmFsaWRhdGVXZWlnaHQuaGFuZGxlcicsXG4gICAgY29kZTogTGFtYmRhQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Z1bmN0aW9ucycpKSxcbiAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDMwKSxcbiAgICBtZW1vcnlTaXplOiAyNTYsXG4gIH0pO1xuXG4gIGNvbnN0IGxhbWJkYURhdGFTb3VyY2UgPSBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZShcbiAgICAnVmFsaWRhdGVXZWlnaHREYXRhU291cmNlJyxcbiAgICB2YWxpZGF0ZVdlaWdodExhbWJkYVxuICApO1xuXG4gIGNvbnN0IHZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24gPSBuZXcgQXBwc3luY0Z1bmN0aW9uKFxuICAgIHNjb3BlLFxuICAgICdWYWxpZGF0ZVdlaWdodEFwcHN5bmNGdW5jdGlvbicsXG4gICAge1xuICAgICAgbmFtZTogJ3ZhbGlkYXRlV2VpZ2h0RnVuY3Rpb24nLFxuICAgICAgYXBpLFxuICAgICAgZGF0YVNvdXJjZTogbGFtYmRhRGF0YVNvdXJjZSxcbiAgICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvdmFsaWRhdGVXZWlnaHQuanMnKVxuICAgICAgKSxcbiAgICB9XG4gICk7XG5cbiAgY29uc3QgY3JlYXRlV2VpZ2h0RnVuY3Rpb24gPSBuZXcgQXBwc3luY0Z1bmN0aW9uKFxuICAgIHNjb3BlLFxuICAgICdDcmVhdGVXZWlnaHRBcHBzeW5jRnVuY3Rpb24nLFxuICAgIHtcbiAgICAgIG5hbWU6ICdjcmVhdGVXZWlnaHRGdW5jdGlvbicsXG4gICAgICBhcGksXG4gICAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihyZXNvbHZlclBhdGgsICdtdXRhdGlvbnMvY3JlYXRlV2VpZ2h0LmpzJylcbiAgICAgICksXG4gICAgfVxuICApO1xuXG4gIGNvbnN0IHVwZGF0ZVdlaWdodEZ1bmN0aW9uID0gbmV3IEFwcHN5bmNGdW5jdGlvbihcbiAgICBzY29wZSxcbiAgICAnVXBkYXRlV2VpZ2h0QXBwc3luY0Z1bmN0aW9uJyxcbiAgICB7XG4gICAgICBuYW1lOiAndXBkYXRlV2VpZ2h0RnVuY3Rpb24nLFxuICAgICAgYXBpLFxuICAgICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL3VwZGF0ZVdlaWdodC5qcycpXG4gICAgICApLFxuICAgIH1cbiAgKTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2dldFVzZXJSZXNvbHZlcicsIHtcbiAgICB0eXBlTmFtZTogJ1F1ZXJ5JyxcbiAgICBmaWVsZE5hbWU6ICdnZXRVc2VyJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncXVlcmllcy9nZXRVc2VyLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2xpc3RVc2Vyc1Jlc29sdmVyJywge1xuICAgIHR5cGVOYW1lOiAnUXVlcnknLFxuICAgIGZpZWxkTmFtZTogJ2xpc3RVc2VycycsXG4gICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ3F1ZXJpZXMvbGlzdFVzZXJzLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2xpc3RXZWlnaHRzQnlVc2VyUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgZmllbGROYW1lOiAnbGlzdFdlaWdodHNCeVVzZXInLFxuICAgIGRhdGFTb3VyY2U6IGFwcERhdGFTb3VyY2UsXG4gICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KFxuICAgICAgcGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ3F1ZXJpZXMvbGlzdFdlaWdodHNCeVVzZXIuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignY3JlYXRlVXNlclJlc29sdmVyJywge1xuICAgIHR5cGVOYW1lOiAnTXV0YXRpb24nLFxuICAgIGZpZWxkTmFtZTogJ2NyZWF0ZVVzZXInLFxuICAgIGRhdGFTb3VyY2U6IGFwcERhdGFTb3VyY2UsXG4gICAgcnVudGltZTogRnVuY3Rpb25SdW50aW1lLkpTXzFfMF8wLFxuICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KHBhdGguam9pbihyZXNvbHZlclBhdGgsICdtdXRhdGlvbnMvY3JlYXRlVXNlci5qcycpKSxcbiAgfSk7XG5cbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCd1cGRhdGVVc2VyUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAndXBkYXRlVXNlcicsXG4gICAgZGF0YVNvdXJjZTogYXBwRGF0YVNvdXJjZSxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKHJlc29sdmVyUGF0aCwgJ211dGF0aW9ucy91cGRhdGVVc2VyLmpzJykpLFxuICB9KTtcblxuICBhcGkuY3JlYXRlUmVzb2x2ZXIoJ2RlbGV0ZVVzZXJSZXNvbHZlcicsIHtcbiAgICB0eXBlTmFtZTogJ011dGF0aW9uJyxcbiAgICBmaWVsZE5hbWU6ICdkZWxldGVVc2VyJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL2RlbGV0ZVVzZXIuanMnKSksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignY3JlYXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAnY3JlYXRlV2VpZ2h0JyxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgcGlwZWxpbmVDb25maWc6IFt2YWxpZGF0ZVdlaWdodEZ1bmN0aW9uLCBjcmVhdGVXZWlnaHRGdW5jdGlvbl0sXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvY3JlYXRlV2VpZ2h0UGlwZWxpbmUuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcigndXBkYXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAndXBkYXRlV2VpZ2h0JyxcbiAgICBydW50aW1lOiBGdW5jdGlvblJ1bnRpbWUuSlNfMV8wXzAsXG4gICAgcGlwZWxpbmVDb25maWc6IFt2YWxpZGF0ZVdlaWdodEZ1bmN0aW9uLCB1cGRhdGVXZWlnaHRGdW5jdGlvbl0sXG4gICAgY29kZTogQ29kZS5mcm9tQXNzZXQoXG4gICAgICBwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAncGlwZWxpbmUvdXBkYXRlV2VpZ2h0UGlwZWxpbmUuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIGFwaS5jcmVhdGVSZXNvbHZlcignZGVsZXRlV2VpZ2h0UmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdNdXRhdGlvbicsXG4gICAgZmllbGROYW1lOiAnZGVsZXRlV2VpZ2h0JyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChwYXRoLmpvaW4ocmVzb2x2ZXJQYXRoLCAnbXV0YXRpb25zL2RlbGV0ZVdlaWdodC5qcycpKSxcbiAgfSk7XG5cbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCd1c2VyV2VpZ2h0c0ZpZWxkUmVzb2x2ZXInLCB7XG4gICAgdHlwZU5hbWU6ICdVc2VyJyxcbiAgICBmaWVsZE5hbWU6ICd3ZWlnaHRzJyxcbiAgICBkYXRhU291cmNlOiBhcHBEYXRhU291cmNlLFxuICAgIHJ1bnRpbWU6IEZ1bmN0aW9uUnVudGltZS5KU18xXzBfMCxcbiAgICBjb2RlOiBDb2RlLmZyb21Bc3NldChcbiAgICAgIHBhdGguam9pbihyZXNvbHZlclBhdGgsICdmaWVsZFJlc29sdmVycy9Vc2VyLndlaWdodHMuanMnKVxuICAgICksXG4gIH0pO1xuXG4gIHJldHVybiBhcGk7XG59O1xuIl19